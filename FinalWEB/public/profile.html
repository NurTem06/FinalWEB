<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #0a0a0a; color: #fff; }
        .profile-container { background: #141414; border-radius: 15px; padding: 30px; border: 1px solid #333; }
        .history-item { background: #1f1f1f; margin-bottom: 10px; padding: 10px; border-radius: 5px; font-size: 0.9rem; }
    </style>
</head>
<body>
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10 profile-container">
            <div class="text-center mb-5">
                <h2 id="titleType" class="text-danger">–ü—Ä–æ—Ñ–∏–ª—å</h2>
                <h3 id="uName">---</h3>
                <p id="uEmail" class="text-secondary"></p>
                <button class="btn btn-outline-light btn-sm" onclick="location.href='index.html'">–ù–∞–∑–∞–¥</button>
                <button id="logoutBtn" class="btn btn-danger btn-sm" onclick="localStorage.clear(); location.href='index.html'">–í—ã–π—Ç–∏</button>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <h5 class="text-danger mb-3"><i class="bi bi-eye"></i> –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</h5>
                    <div id="watchHistory"></div>
                </div>
                <div class="col-md-6">
                    <h5 class="text-danger mb-3"><i class="bi bi-star"></i> –û—Ü–µ–Ω–∫–∏ –∏ –æ—Ç–∑—ã–≤—ã</h5>
                    <div id="rateHistory"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function init() {
        const token = localStorage.getItem('token');
        const urlParams = new URLSearchParams(window.location.search);
        const targetId = urlParams.get('id');
        const myData = JSON.parse(localStorage.getItem('user'));

        if(!token) return window.location.href = 'index.html';

        const fetchId = targetId || myData.id || myData._id;

        try {
            const res = await fetch(`/api/users/${fetchId}`, { headers: {'x-access-token': token} });
            const data = await res.json();
            const { user, reviews } = data;

            document.getElementById('uName').innerText = user.username;
            document.getElementById('uEmail').innerText = user.email;

            if(targetId && targetId !== (myData.id || myData._id)) {
                document.getElementById('logoutBtn').style.display = 'none';
                document.getElementById('titleType').innerText = "–ü—Ä–æ—Ñ–∏–ª—å –∫–∏–Ω–æ–º–∞–Ω–∞";
            }

            // –†–µ–Ω–¥–µ—Ä –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
            document.getElementById('watchHistory').innerHTML = user.watched.length 
                ? user.watched.map(m => `<div class="history-item">üé¨ ${m.title}</div>`).join('')
                : '<p class="text-muted">–ù–µ—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å–º–æ–≤</p>';

            // –†–µ–Ω–¥–µ—Ä –æ—Ü–µ–Ω–æ–∫
            document.getElementById('rateHistory').innerHTML = reviews.length
                ? reviews.map(r => `
                    <div class="history-item">
                        <b>${r.movie?.title}</b> ‚Äî <span class="text-warning">${r.rating}/10</span>
                        <br><small class="text-secondary">"${r.content}"</small>
                    </div>`).join('')
                : '<p class="text-muted">–ù–µ—Ç –æ—Ü–µ–Ω–æ–∫</p>';

        } catch (e) { console.error(e); }
    }
    window.onload = init;
</script>
</body>
</html>